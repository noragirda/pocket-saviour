<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>PocketSaviour ‚Äì Task 12: Moderate Disputes</title>

  <link rel="stylesheet" href="../styles/tokens.css" />
  <link rel="stylesheet" href="../styles/base.css" />
  <link rel="stylesheet" href="../styles/components.css" />
  <link rel="stylesheet" href="../styles/task12.css" />
</head>
<body>
  <div class="app-frame">
    <main id="app" aria-live="polite"></main>
  </div>

  <script type="module">
    import { createRouter } from "../js/router.js";
    import {
      Task12Context,
      Task12OpenCases,
      Task12ClaimDetails,
      Task12ContactParties,
      Task12EvaluateResolution,
      Task12NotifyUsers
    } from "../js/screens/task12.js";

    const mount = (html) => {
      document.getElementById("app").innerHTML = html;
    };

    const router = createRouter({
      routes: {
        "#/home": () => router.navigate("#/task12/context"),
        "#/task12": () => router.navigate("#/task12/context"),
        "#/task12/context": () => Task12Context({ mount, router }),
        "#/task12/cases": () => Task12OpenCases({ mount, router }),
        "#/task12/details": () => Task12ClaimDetails({ mount, router }),
        "#/task12/contact": () => Task12ContactParties({ mount, router }),
        "#/task12/evaluate": () => Task12EvaluateResolution({ mount, router }),
        "#/task12/notify": () => Task12NotifyUsers({ mount, router })
      },
      onNotFound: () => router.navigate("#/task12/context")
    });

    router.start();
  </script>
</body>
</html>

  // Demo disputes
  const DISPUTES = [
    {
      id:"DSP-10041",
      title:"Refund requested ‚Äì leak reappeared",
      complainant:"User: Ana M.",
      provider:"Provider: Andrei Pop ‚Äì Plumbing",
      date:"Nov 1, 2025",
      policy:"Service redo / partial refund",
      evidence:["Photo ‚Äì pipe","Chat ‚Äì repair","Invoice"]
    },
    {
      id:"DSP-10042",
      title:"Extra time billed dispute",
      complainant:"User: Casa Verde",
      provider:"Provider: Dan Electric SRL",
      date:"Oct 30, 2025",
      policy:"Fair billing"
    }
  ];

  const State = {
    selectedId: null,
    decision: null // "refund","provider-wins","redo","split"
  };

  function renderCases(){
    const list = document.getElementById('casesList');
    if(!list) return;
    list.innerHTML = '';
    DISPUTES.forEach(d=>{
      const div = document.createElement('div');
      div.className = 'dispute-item';
      div.innerHTML = `
        <div class="avatar" aria-hidden="true"></div>
        <div style="flex:1;">
          <div class="row" style="justify-content:space-between;">
            <div class="col" style="gap:2px;">
              <div><b>${d.title}</b></div>
              <div class="small">${d.complainant} vs ${d.provider}</div>
              <div class="small">Opened: ${d.date}</div>
            </div>
            <a class="btn ghost" data-id="${d.id}">Open</a>
          </div>
        </div>
      `;
      list.appendChild(div);
    });
    list.querySelectorAll('a.btn.ghost').forEach(a=>{
      a.addEventListener('click', e=>{
        e.preventDefault();
        const id = a.getAttribute('data-id');
        State.selectedId = id;
        fillClaim();
        go('02_Claim_Details');
      });
    });
  }

  function getSelected(){
    return DISPUTES.find(d=>d.id===State.selectedId) || DISPUTES[0];
  }

  function fillClaim(){
    const d = getSelected();
    if(!d) return;
    const cId = document.getElementById('claimId');
    const cTitle = document.getElementById('claimTitle');
    const cParties = document.getElementById('claimParties');
    const cDate = document.getElementById('claimDate');
    const cPolicy = document.getElementById('claimPolicy');
    if(cId) cId.textContent = d.id;
    if(cTitle) cTitle.textContent = d.title;
    if(cParties) cParties.textContent = `${d.complainant} ‚Ä¢ ${d.provider}`;
    if(cDate) cDate.textContent = d.date;
    if(cPolicy) cPolicy.textContent = d.policy || '‚Äî';

    // evidence
    const ev = document.getElementById('evidenceGrid');
    if(ev){
      ev.innerHTML = '';
      (d.evidence || []).forEach(e=>{
        const t = document.createElement('div');
        t.className = 'evidence-tile';
        t.innerHTML = `<div style="font-size:32px;">üìÑ</div><div class="body" style="font-size:12px;">${e}</div>`;
        ev.appendChild(t);
      });
      if(!(d.evidence || []).length){
        ev.innerHTML = '<div class="body muted">No files attached.</div>';
      }
    }
  }

  function chooseDecision(el, val){
    const group = document.getElementById('decChips');
    if(group){
      group.querySelectorAll('.chip').forEach(c=>c.classList.remove('active'));
    }
    el.classList.add('active');
    State.decision = val;
  }

  function submitResolution(){
    const outId = document.getElementById('resCaseId');
    const outRes = document.getElementById('resDecision');
    const d = getSelected();
    if(outId) outId.textContent = d ? d.id : '‚Äî';
    const map = {
      "refund":"Refund to client",
      "provider-wins":"Provider decision upheld",
      "redo":"Redo service",
      "split":"Split responsibility"
    };
    if(outRes) outRes.textContent = map[State.decision] || '‚Äî';
    go('05_Notify_Users');
  }

  window.addEventListener('load', renderCases);
</script>
</head>
<body>

<!-- 00 Context -->
<section class="screen" id="00_Context_ModerateDisputes">
  <div class="title">Moderate Disputes</div>
  <div class="card">
    <div class="subtitle">Purpose & Motivation</div>
    <div class="body">Resolve complaints fairly and keep the platform‚Äôs reputation healthy.</div>
    <div class="divider"></div>
    <div class="row" style="flex-wrap:wrap; gap:8px;">
      <span class="badge">Context: Admin environment</span>
      <span class="badge">Starting: Open dispute cases</span>
      <span class="badge">Evidence + messages</span>
    </div>
  </div>
  <div class="card">
    <div class="label">Flow steps</div>
    <ol class="body" style="padding-left:20px;">
      <li>Read claim details & materials</li>
      <li>Contact both parties</li>
      <li>Evaluate evidence & policy</li>
      <li>Decide resolution & update</li>
      <li>Notify users of the decision</li>
    </ol>
  </div>
  <div class="sticky-actions">
    <a href="#01_Open_Cases" class="btn primary" onclick="return go('01_Open_Cases')">Open dispute cases</a>
  </div>
</section>

<!-- 01 Open cases list -->
<section class="screen" id="01_Open_Cases">
  <div class="title">Open dispute cases</div>
  <div class="body muted">Pick a case to moderate.</div>

  <div id="casesList" class="col">
    <!-- populated by JS -->
  </div>

  <div class="sticky-actions">
    <a href="#00_Context_ModerateDisputes" class="btn secondary" onclick="return go('00_Context_ModerateDisputes')">Back</a>
  </div>
</section>

<!-- 02 Claim details & evidence -->
<section class="screen" id="02_Claim_Details">
  <div class="title">Claim details</div>

  <div class="card">
    <div class="label">Case ID</div>
    <div class="body" id="claimId">‚Äî</div>
    <div class="label" style="margin-top:8px;">Title</div>
    <div class="body" id="claimTitle">‚Äî</div>
    <div class="label" style="margin-top:8px;">Parties</div>
    <div class="body" id="claimParties">‚Äî</div>
    <div class="label" style="margin-top:8px;">Opened</div>
    <div class="body muted" id="claimDate">‚Äî</div>
  </div>

  <div class="card">
    <div class="label">Supporting materials</div>
    <div id="evidenceGrid" class="evidence-grid">
      <!-- evidence tiles -->
    </div>
  </div>

  <div class="card">
    <div class="label">Policy to check</div>
    <div class="body" id="claimPolicy">‚Äî</div>
  </div>

  <div class="sticky-actions">
    <a href="#03_Contact_Parties" class="btn primary" onclick="return go('03_Contact_Parties')">Contact parties</a>
    <a href="#01_Open_Cases" class="btn secondary" onclick="return go('01_Open_Cases')">Back</a>
  </div>
</section>

<!-- 03 Contact both parties -->
<section class="screen" id="03_Contact_Parties">
  <div class="title">Contact parties</div>
  <div class="body muted">Ask for clarifications, missing receipts, or context.</div>

  <div class="card">
    <div class="label">To: Complainant</div>
    <div class="chat-bubble">
      <b>Admin ‚Üí Ana M.</b><br/>
      Hello! Can you confirm the date the leak reappeared and share 1 more photo?
    </div>
    <textarea placeholder="Write a message to the complainant..."></textarea>
  </div>

  <div class="card">
    <div class="label">To: Provider</div>
    <div class="chat-bubble">
      <b>Admin ‚Üí Andrei Pop ‚Äì Plumbing</b><br/>
      Please confirm what work was done and whether a redo was proposed.
    </div>
    <textarea placeholder="Write a message to the provider..."></textarea>
  </div>

  <div class="sticky-actions">
    <a href="#04_Evaluate_Resolution" class="btn primary" onclick="return go('04_Evaluate_Resolution')">Evaluate & resolve</a>
    <a href="#02_Claim_Details" class="btn secondary" onclick="return go('02_Claim_Details')">Back</a>
  </div>
</section>

<!-- 04 Evaluate evidence & decide -->
<section class="screen" id="04_Evaluate_Resolution">
  <div class="title">Evaluate & decide</div>
  <div class="body muted">Match evidence against policy and pick an outcome.</div>

  <div class="card">
    <div class="label">Policy compliance checklist</div>
    <div class="col">
      <label class="row" style="align-items:flex-start;"><input type="checkbox" style="margin-top:4px;"/> <span class="body">Client reported within allowed time window.</span></label>
      <label class="row" style="align-items:flex-start;"><input type="checkbox" style="margin-top:4px;"/> <span class="body">Provider‚Äôs completion proof is attached.</span></label>
      <label class="row" style="align-items:flex-start;"><input type="checkbox" style="margin-top:4px;"/> <span class="body">Evidence shows issue persists.</span></label>
    </div>
  </div>

  <div class="card">
    <div class="label">Resolution</div>
    <div id="decChips" class="chips">
      <span class="chip" onclick="chooseDecision(this,'refund')">Refund client</span>
      <span class="chip" onclick="chooseDecision(this,'redo')">Ask provider to redo</span>
      <span class="chip" onclick="chooseDecision(this,'provider-wins')">Provider wins</span>
      <span class="chip" onclick="chooseDecision(this,'split')">Split responsibility</span>
    </div>
  </div>

  <div class="card">
    <div class="label">Moderator note</div>
    <textarea placeholder="E.g., Client reported within 24h; photo shows issue persists; approve partial refund."></textarea>
  </div>

  <div class="sticky-actions">
    <a href="#05_Notify_Users" class="btn primary" onclick="submitResolution(); return false;">Save & notify</a>
    <a href="#03_Contact_Parties" class="btn secondary" onclick="return go('03_Contact_Parties')">Back</a>
  </div>
</section>

<!-- 05 Notify both users -->
<section class="screen" id="05_Notify_Users">
  <div class="title">Decision sent ‚úÖ</div>
  <div class="body muted">We notified both the complainant and the provider.</div>

  <div class="card">
    <div class="label">Case</div>
    <div class="body" id="resCaseId">‚Äî</div>
    <div class="label" style="margin-top:8px;">Resolution</div>
    <div class="body" id="resDecision">‚Äî</div>
  </div>

  <div class="card">
    <div class="label">Notifications</div>
    <ul class="body" style="padding-left:20px;">
      <li>In-app message to complainant</li>
      <li>In-app message to provider</li>
      <li>Case closed in system records</li>
    </ul>
  </div>

  <div class="card">
    <div class="label">Status</div>
    <div class="status ok">‚óè Closed</div>
    <div class="body muted">This improves the platform‚Äôs fairness score.</div>
  </div>

  <div class="sticky-actions">
    <a href="#01_Open_Cases" class="btn primary" onclick="return go('01_Open_Cases')">Back to open cases</a>
    <a href="#00_Context_ModerateDisputes" class="btn secondary" onclick="return go('00_Context_ModerateDisputes')">Flow overview</a>
  </div>
</section>

</body>
</html>